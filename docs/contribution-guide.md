# Contribution Guidance

## Overview

## Meta Service Broker

## Service Module

If you want to implement a new service module, you can just create a new directory under the directory `services/`. The new directory name is recommended to be the service name.

You need to implement the following functions in the service module, and register them in `meta-azure-service-broker/index.js`.

* Handlers.catalog = function(log, params, next)
* Handlers.provision = function(log, params, next)
* Handlers.poll = function(log, params, next)
* Handlers.deprovision = function(log, params, next)
* Handlers.bind = function(log, params, next)
* Handlers.unbind = function(log, params, next)

About the parameters

1. log

  The logging handler which the service module can use to log messages. See details below.

2. params

  a valid JSON Object ({}). This is for the meta service broker to pass information to the service module. See details below.

  The future compatibility is the reason why the JSON object is used; it will be easier to add fields in the future if JSON is expected.

  params may contain three parts: azure part, http request part and service module specific part. 

    a. The azure part is the environment (AzureCloud, AzureChinaCloud), service principals (tenant_id, client_id, client_secret) and the subscription_id.

    b. The http request part is generated by Cloud Foundry Cloud Controller, including some GUIDs and the arbitrary parameters (http://docs.cloudfoundry.org/devguide/services/managing-services.html#arbitrary-params-create) about the service.

    c. The service module specific part is the result of provisioning and binding, see bellows.

3. next

  next is a callback function the service module uses to report the result.

### catalog function

Handlers.catalog = function(log, params, next)

* params

  ```
  {
    "azure":{
      "environment":"AzureCloud",
      "subscription_id":"Your-Subscription-ID",
      "tenant_id":"Your-Tenant-ID",
      "client_id":"Your-Client-ID",
      "client_secret":"Your-Client-Secret"
    }
  }
  ```

* next(err, reply)

  * err should be null if the operation is succeeded. Otherwise, err should be a valid JSON object.

    ```
    {
      statusCode: e.g. 404,
      code: "e.g. NotFound",
      description: "e.g. The resource is not found."
    }
    ```

  * reply should be a JSON-format string which includes the service offering and plans. For example:

  ```
  {
    "id": "2e2fc314-37b6-4587-8127-8f9ee8b33fea",  <- GUID which is generated by yourself
    "name": "azurestorageblob",
    "description": "Provides Azure Storage Blob Service, including storage account creation, container creation, access key generation",
    "bindable": true,
    "tags": [
      "Azure",
      "Storage",
      "Blob"
    ],
    "plans": [{
      "id": "6ddf6b41-fb60-4b70-af99-8ecc4896b3cf",  <- GUID which is generated by yourself
      "name": "default",
      "description": "An Azure Storage Blob Service plan providing a single container with unlimited storage."
    }]
  }
  ```

More information:
http://docs.cloudfoundry.org/services/api.html#catalog-mgmt

### Provision function

Handlers.provision = function(log, params, next)

It should be an asynchronous operation.

* params

  ```
  {
    "instance_id":"instance guid generated by cc",
    "accepts_incomplete":"true",
    "organization_guid":"organization guid generated by cc",
    "plan_id":"plan guid which is in the service module’s catalog",
    "service_id":"service guid which is in the service module’s catalog",
    "space_guid":"space guid generated by cc",
    "parameters":{
      "foo":"bar"
    },
    "azure":{
      "environment":"AzureCloud",
      "subscription_id":"Your-Subscription-ID",
      "tenant_id":"Your-Tenant-ID",
      "client_id":"Your-Client-ID",
      "client_secret":"Your-Client-Secret"
    }
  }
  ```

  Example:
  
    ```
    {
      "id":"dbf4e995-e236-48cb-8d99-3698e5d6611b",
      "accepts_incomplete":"true",
      "organization_guid":"5d333cdb-30f8-4e07-856f-fae4d98738f2",
      "plan_id":"6ddf6b41-fb60-4b70-af99-8ecc4896b3cf",
      "service_id":"2e2fc314-37b6-4587-8127-8f9ee8b33fea",
      "space_guid":"66577389-4c40-4096-a75b-ab6f6ab97f9c",
      "parameters":{
        "resource_group_name":"binxi031401",
        "storage_account_name":"binxi031401sa"
      },
      "azure":{
        "environment":"AzureCloud",
        "subscription_id":"Your-Subscription-ID",
        "tenant_id":"Your-Tenant-ID",
        "client_id":"Your-Client-ID",
        "client_secret":"Your-Client-Secret"
      }
    }
    ```

  Users can define arbitrary parameters, e.g. storage account name, storage account type.

* next(err, reply, result)

  * err should be null if the operation is succeeded. Otherwise, err should be a valid JSON object.

    ```
    {
      statusCode: e.g. 404,
      code: "e.g. NotFound",
      description: "e.g. The resource is not found."
    }
    ```

  * reply should be a JSON object.

    ```
    {
      StatusCode: 202,
      code: "Accepted",
      value: {}
    }
    ```

  * result should be a valid JSON object which is determined by the service module.

    When the provisioning operation of the service module is called, it should pass the provisioning result to the broker via the callback function. And the broker will store the provisioning result (module-centric data) in the database. The provisioning result may be an in-progress result because creating Azure resources is an asynchronous operation. You can update the provisioning result when the polling operation is called. And the provisioning result will be passed to the module in future operations (binding, unbinding, deprovisioning).

### Poll function

Handlers.poll = function(log, params, next)

* params

  ```
  {
    "instance_id":"instance guid generated by cc",
    "service_id":"service guid which is in the service module’s catalog",
    "plan_id":"plan guid which is in the service module’s catalog",
    "organization_guid":"organization guid generated by cc",
    "space_guid":"space guid generated by cc",
    "parameters":{
      "foo":"bar"
    },
    "last_operation":"provision or deprovision",
    "provisioning_result":{
      "bar":"foo"
    },
    "azure":{
      "environment":"AzureCloud",
      "subscription_id":"Your-Subscription-ID",
      "tenant_id":"Your-Tenant-ID",
      "client_id":"Your-Client-ID",
      "client_secret":"Your-Client-Secret"
    }
  }
  ```

  * If the last operation is provision, you can query the provisioning state of the service instance by name (e.g. resource_group_name /storage_account_name).

  * If the last operation is deprovision, you can query the deprovisioning state of the service instance by name (e.g. resource_group_name /storage_account_name).

* next(err, reply, result)

  * err should be null if the operation is succeeded. Otherwise, err should be a valid JSON object.

    ```
    {
      statusCode: e.g. 404,
      code: "e.g. NotFound",
      description: "e.g. The resource is not found."
    }
    ```

  * reply should be a JSON object.

    ```
    {
      StatusCode: 200,
      code: "OK",
      value: {
        "state": "in progress",
        "description": "Creating service (10% complete)."
      }
    }
    ```

  * result should be a valid JSON object which is determined by the service module.

    You can update the provisioning result when the polling operation is called. And the provisioning result will be passed to the module in future operations (binding, unbinding, deprovisioning).

### Deprovision function

Handlers.deprovision = function(log, params, next)

It should be an asynchronous operation.

* params

  ```
  {
    "instance_id":"instance guid generated by cc",
    "accepts_incomplete":"true",
    "plan_id":"plan guid which is in the service module’s catalog",
    "service_id":"service guid which is in the service module’s catalog",
    "parameters":{
      "foo":"bar"
    },
    "provisioning_result": {
      "foo":"bar"
    },
    "azure":{
      "environment":"AzureCloud",
      "subscription_id":"Your-Subscription-ID",
      "tenant_id":"Your-Tenant-ID",
      "client_id":"Your-Client-ID",
      "client_secret":"Your-Client-Secret"
    }
  }
  ```

  Users can define arbitrary parameters, e.g. storage account name, storage account type.

* next(err, reply, result)

  * err should be null if the operation is succeeded. Otherwise, err should be a valid JSON object.

    ```
    {
      statusCode: e.g. 404,
      code: "e.g. NotFound",
      description: "e.g. The resource is not found."
    }
    ```

  * reply should be a JSON object.

    ```
    {
      StatusCode: 202,
      code: "Accepted",
      value: {}
    }
    ```

  * result should be a valid JSON object which is determined by the service module. This parameter may be deprecated in future.


### Bind function

Handlers.bind = function(log, params, next)

* params

  ```
  {
    "instance_id":"instance guid generated by cc",
    "binding_id":"binding guid generated by cc",
    "plan_id":"plan guid which is in the service module’s catalog",
    "service_id":"service guid which is in the service module’s catalog",
    "app_guid":"app guid generated by cc",
    "parameters":{
      "foo":"bar"
    },
    "provisioning_result": {
      "foo":"bar"
    },
    "azure":{
      "environment":"AzureCloud",
      "subscription_id":"Your-Subscription-ID",
      "tenant_id":"Your-Tenant-ID",
      "client_id":"Your-Client-ID",
      "client_secret":"Your-Client-Secret"
    }
  }
  ```

* next(err, reply, result)

  * err should be null if the operation is succeeded. Otherwise, err should be a valid JSON object.

    ```
    {
      statusCode: e.g. 404,
      code: "e.g. NotFound",
      description: "e.g. The resource is not found."
    }
    ```

  * reply should be a JSON object.

    ```
    {
      StatusCode: 201,
      code: "Created",
      value: {
        credentials: {
          storage_account_name: storageAccountName,
          container_name: containerName,
          primary_access_key: primaryAccessKey,
          secondary_access_key: secondaryAccessKey,
        }
      }
    }
    ```

    The contents of the credentials should be determined by your service module. Applications can use these credentials to access the service instance. E.g. For Azure storage blob service, the credentials are storage_account_name, container_name, primary_access_key and secondary_access_key. For SQL server service, the credentials should be the connection string.

  * result should be a valid JSON object which is determined by the service module.

    When the binding operation of the service module is called, it should pass the binding result to the broker via the callback function. And the broker will store the binding result (module-centric data) in the database. And the binding result will be passed to the module in future operations (only unbinding).

### Unbind function

Handlers.unbind = function(log, params, next)

When the unbinding function of the service module is called, the broker will delete the binding specific information (everything associated with the bindingId.).

* params

  ```
  {
    "instance_id":"instance guid generated by cc",
    "binding_id":"binding guid generated by cc",
    "plan_id":"plan guid which is in the service module’s catalog",
    "service_id":"service guid which is in the service module’s catalog",
    "provisioning_result": {
      "foo":"bar"
    },
    "binding_result": {
      "foo":"bar"
    },
    "azure":{
      "environment":"AzureCloud",
      "subscription_id":"Your-Subscription-ID",
      "tenant_id":"Your-Tenant-ID",
      "client_id":"Your-Client-ID",
      "client_secret":"Your-Client-Secret"
    }
  }
  ```

* next(err, reply, result)

  * err should be null if the operation is succeeded. Otherwise, err should be a valid JSON object.

    ```
    {
      statusCode: e.g. 404,
      code: "e.g. NotFound",
      description: "e.g. The resource is not found."
    }
    ```

  * reply should be a JSON object.
  
    ```
    {
      StatusCode: 200,
      code: "OK",
      value: {}
    }
    ```

  * result should be a valid JSON object which is determined by the service module. This parameter may be deprecated in future.

### Logging

There are four log levels:

* DEBUG
* INFO
* WARN
* ERROR

By default, all the logs will be outputted to stdout and stderr. You can get the recent logs via "cf logs APP_NAME --recent".

## Test Locally

1. Setup the environment variables.

  ```
  export environment="REPLACE-ME"
  export client_id="REPLACE-ME"
  export client_secret="REPLACE-ME"
  export subscription_id="REPLACE-ME"
  export tenant_id="REPLACE-ME"
  ```

2. Clone the codes and install dependencies.

  ```
  git clone https://github.com/Azure/meta-azure-service-broker
  cd meta-azure-service-broker
  npm install
  ```

3. Start the server.

  1. Create a SQL database.

    You have serveral options to create a SQL database.

    * [Create an Azure SQL database](https://azure.microsoft.com/en-us/documentation/articles/sql-database-get-started/)
    * Create a SQL server VM on Azure

  2. Create tables in the SQL database.

    1. Use your favorite way to connect to the SQL database.

      For example:

      ```
      sudo npm install -g sql-cli
      mssql --server "<server-name>.database.windows.net" --database <database> --user <username>@<server-name> --pass <pass> --encrypt
      ```

    2. Create tables `instances` and `bindings` according to [schema.sql](../scripts/schema.sql).

  2. Update the configurations.

    Update `config/default.json` with the configurations of the SQL database.

  3. Start the server.

    ```
    npm start
    ```

    By default, the server will be running on `localhost:5001`.

4. Run the following scripts in [scripts/operations/](../scripts/operations/).

  * `./catalog`
  * `./provision`
  * `./poll`
  * `./bind`
  * `./unbind`
  * `./deprovision`

  1. Update `service_id` and `plan_id` according to the service which you want to test.

    For example, if you want to test `azurestorageblob` service, you need to make sure that `service_id` and `plan_id` are set properly according to [the service offerings](../lib/services/azurestorageblob/catalog.json).

  2. Update `parameters` if it is supported by the service.

    For example, `azurestorageblob` service allows users to specify the storage account name when provisioning.
